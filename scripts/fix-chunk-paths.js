/**
 * Fix chunk paths in HTML files
 */
const fs = require('fs');
const path = require('path');

console.log('Fixing chunk paths in HTML files...');

// Find all HTML files
const htmlFiles = [];
const findHtmlFiles = (dir) => {
  fs.readdirSync(dir, { withFileTypes: true }).forEach(dirent => {
    const fullPath = path.join(dir, dirent.name);
    if (dirent.isDirectory()) {
      findHtmlFiles(fullPath);
    } else if (dirent.name.endsWith('.html')) {
      htmlFiles.push(fullPath);
    }
  });
};

const outDir = path.join(process.cwd(), 'out');
if (fs.existsSync(outDir)) {
  findHtmlFiles(outDir);
  console.log(`Found ${htmlFiles.length} HTML files to fix chunk paths`);
  
  htmlFiles.forEach(htmlFile => {
    let content = fs.readFileSync(htmlFile, 'utf8');
    
    // Fix script paths to chunks
    content = content.replace(
      /src="\/farmers-market-directory\/\/farmers-market-directory\/_next/g, 
      'src="/farmers-market-directory/_next'
    );
    
    // Fix double slashes in paths
    content = content.replace(
      /\/farmers-market-directory\/\//g, 
      '/farmers-market-directory/'
    );
    
    // Fix incorrect chunk paths generated by Next.js
    content = content.replace(
      /_next\/static\/chunks\//g,
      '_next/static/chunks/'
    );
    
    // Make sure all asset paths have the correct base path
    content = content.replace(
      /src="(\/_next\/static\/chunks\/)/g,
      'src="/farmers-market-directory$1'
    );
    
    fs.writeFileSync(htmlFile, content);
    console.log(`Fixed chunk paths in: ${htmlFile}`);
  });
} else {
  console.error('Output directory not found:', outDir);
}

console.log('Fixed chunk paths in HTML files'); 